<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Klaster</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: #f0f4f5;
        font-family: "Segoe UI", sans-serif;
      }

      .logo {
        max-height: 100px;
      }

      .table-responsive {
        position: relative;
        max-height: 75vh;
        overflow: auto;
      }

      .table th,
      .table thead th {
        background-color: #198754 !important;
        color: white !important;
        font-size: 0.72rem;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }

      .table td {
        font-size: 0.72rem;
        vertical-align: middle;
        white-space: nowrap;
      }

      /* Sticky headers */
      .table thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        z-index: 3;
      }

      .table thead tr:nth-child(2) th {
        position: sticky;
        top: 34px;
        z-index: 2;
      }

      .bulan-input {
        width: 45px;
        font-size: 0.72rem;
        text-align: center;
      }

      .updated {
        background-color: #d1e7dd !important;
      }
      th.indikator-col,
      td.indikator-col {
        max-width: 200px; /* Ubah sesuai kebutuhan, misalnya 150px */
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
      }

      .bg-biru {
        background-color: #2196f3;
        color: white;
      }
      .bg-hijau {
        background-color: #4caf50;
        color: white;
      }
      .bg-kuning {
        background-color: #ffeb3b;
        color: black;
      }
      .bg-merah {
        background-color: #f44336;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid py-4" style="max-width: 95%; margin: auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-center mb-4">
            <h4 class="fw-bold mb-0">
              IDENTIFIKASI MASALAH HASIL CAPAIAN UKM TAHUN 2025
            </h4>
          </div>

          <div class="d-flex justify-content-start mb-3">
            <a href="index.html" class="btn btn-outline-success shadow-sm"
              >⬅️ Kembali</a
            >
          </div>

          <div class="mb-3">
            <label for="bulanSelect" class="form-label fw-bold"
              >Pilih Bulan:</label
            >
            <select
              id="bulanSelect"
              class="form-select form-select-sm"
              style="max-width: 200px"
            >
              <option value="Juli">Semua Bulan</option>
              <!-- default tampil semua bulan dengan bulan ini = "Juli" -->
              <option value="Jan">Januari</option>
              <option value="Feb">Februari</option>
              <option value="Mar">Maret</option>
              <option value="Apr">April</option>
              <option value="Mei">Mei</option>
              <option value="Juni">Juni</option>
              <option value="Juli">Juli</option>
              <option value="Agst">Agustus</option>
              <option value="Sept">September</option>
              <option value="Okt">Oktober</option>
              <option value="Nov">November</option>
              <option value="Des">Desember</option>
            </select>
          </div>

          <div class="table-responsive" style="font-size: 11px">
            <table
              class="table table-bordered table-striped align-middle"
              id="programTable"
            >
              <thead class="table-success text-center align-middle">
                <tr>
                  <th rowspan="2">No</th>
                  <th rowspan="2" class="indikator-col">Indikator Kerja</th>
                  <th colspan="2">Bulan</th>
                  <th rowspan="2" id="targetHeader">% Target s/d Bulan ...</th>
                  <th rowspan="2">
                    % CAKUPAN s/d Bulan <span id="cakupanBulan">...</span>
                  </th>
                  <th rowspan="2" id="kesenjangan">% Kesenjangan</th>
                  <th rowspan="2" id="Tren">TREN</th>
                  <th rowspan="2">GRADE</th>
                  <th rowspan="2">Analisa Masalah</th>
                </tr>
                <tr>
                  <th>Bulan Lalu</th>
                  <th>Bulan Ini</th>
                </tr>
              </thead>
              <tbody id="tableBody">
                <tr>
                  <td colspan="25" class="text-center">Memuat data...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      const endpoint =
        "https://script.google.com/macros/s/AKfycbyXUb1qcb9YTr8nv4C1Ad2p2ifqosTbRBF0B-rg8bb1f2Tc9hy4LMwrIaZia1YIkPMD6w/exec";

      let originalData = [];

      const bulanKeys = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "Mei",
        "Juni",
        "Juli",
        "Agst",
        "Sept",
        "Okt",
        "Nov",
        "Des",
      ];

      const labelMap = {
        Jan: "Januari",
        Feb: "Februari",
        Mar: "Maret",
        Apr: "April",
        Mei: "Mei",
        Juni: "Juni",
        Juli: "Juli",
        Agst: "Agustus",
        Sept: "September",
        Okt: "Oktober",
        Nov: "November",
        Des: "Desember",
      };

      const masalahMap = {
        Januari: "Masalah_Jan",
        Februari: "Masalah_Feb",
        Maret: "Masalah_Mar",
        April: "Masalah_Apr",
        Mei: "Masalah_Mei",
        Juni: "Masalah_Jun",
        Juli: "Masalah_Jul",
        Agustus: "Masalah_Agu",
        September: "Masalah_Sep",
        Oktober: "Masalah_Okt",
        November: "Masalah_Nov",
        Desember: "Masalah_Des",
      };

      let selectedBulan = "Juli";

      window.onload = function () {
        fetch(endpoint)
          .then((res) => res.json())
          .then((data) => {
            originalData = data;
            renderTable(originalData, selectedBulan);
          })
          .catch((err) => {
            document.getElementById("tableBody").innerHTML =
              "<tr><td colspan='25' class='text-center text-danger'>Gagal memuat data</td></tr>";
            console.error("Fetch error:", err);
          });
      };

      function renderTable(data, bulan) {
        const tbody = document.getElementById("tableBody");

        if (!data || data.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='25' class='text-center'>Tidak ada data tersedia.</td></tr>";
          return;
        }

        const idx = bulanKeys.indexOf(bulan);
        const bulanIniKey = bulanKeys[idx];
        const bulanLaluKey = bulanKeys[idx - 1] || null;
        const labelBulan = labelMap[bulanIniKey];
        const kolomMasalah = masalahMap[labelBulan] || "Masalah_Jan";

        // Ubah header bulan dinamis
        document.querySelectorAll("thead tr:nth-child(2) th")[0].innerText =
          bulanLaluKey ? labelMap[bulanLaluKey] : "-";
        document.querySelectorAll("thead tr:nth-child(2) th")[1].innerText =
          labelMap[bulanIniKey];

        // Ubah header target dinamis
        document.getElementById(
          "targetHeader"
        ).innerText = `% Target s/d Bulan ${labelBulan}`;

        // Ubah header cakupan kumulatif dinamis
        document.getElementById("cakupanBulan").innerText = labelBulan;

        let grouped = {};
        data.forEach((row) => {
          const sub = row.Sub || "Tanpa Sub";
          if (!grouped[sub]) grouped[sub] = [];
          grouped[sub].push(row);
        });

        let rows = "";
        let counter = 1;

        for (let sub in grouped) {
          const rowsInSub = grouped[sub];
          const program = rowsInSub[0].Induk || "";

          rows += `
            <tr>
              <td colspan="11" class="fw-bold text-danger" style="background-color: #f8d7da;">
                ${program}
              </td>
            </tr>
            <tr>
              <td colspan="11" class="fw-semibold text-primary" style="background-color: #e2e3f3;">
                ${sub}
              </td>
            </tr>
          `;

          rowsInSub.forEach((row) => {
            const indikator = row["Indikator Kerja"] || "-";
            const bulanIniVal = parseFloat(row[bulanIniKey]);
            let bulanLaluVal;

            if (bulan === "Jan") {
              bulanLaluVal = 0;
            } else {
              bulanLaluVal = bulanLaluKey ? parseFloat(row[bulanLaluKey]) : NaN;
            }

            const targetTahun = parseFloat(row["Target 2025"]) || 0;

            // Hitung target s/d bulan ini dalam persen
            const targetSD = targetTahun
              ? (
                  (((targetTahun / 12) * (idx + 1)) / targetTahun) *
                  100
                ).toFixed(2)
              : "-";

            // Hitung kumulatif pencapaian s/d bulan ini
            let totalCapaian = 0;
            for (let i = 0; i <= idx; i++) {
              const val = parseFloat(row[bulanKeys[i]]);
              if (!isNaN(val)) totalCapaian += val;
            }

            const cakupanSD = targetTahun
              ? ((totalCapaian / targetTahun) * 100).toFixed(2)
              : "-";

            const masalahBulanIni = row[kolomMasalah] || "";

            // GAP & TREN
            let gap = "-";
            let tren = "➡️";
            let trenClass = "";

            if (!isNaN(bulanIniVal) && !isNaN(bulanLaluVal)) {
              const selisih = (bulanIniVal - bulanLaluVal).toFixed(2);
              gap = `${selisih > 0 ? "+" : ""}${selisih}`;

              if (selisih > 0) {
                tren = "⬆️";
                trenClass = "bg-success text-white";
              } else if (selisih < 0) {
                tren = "⬇️";
                trenClass = "bg-danger text-white";
              }
            }

            // --- GRADE LOGIC ---
            let grade = "-";
            let gradeDesc = "";
            let gradeClass = ""; // ini untuk kelas warna

            if (
              !isNaN(bulanIniVal) &&
              !isNaN(bulanLaluVal) &&
              !isNaN(cakupanSD) &&
              !isNaN(targetSD)
            ) {
              const capaianNaik = bulanIniVal > bulanLaluVal;
              const capaianTurun = bulanIniVal < bulanLaluVal;
              const capaianSama = bulanIniVal === bulanLaluVal;
              const kumulatifCukup =
                parseFloat(cakupanSD) >= parseFloat(targetSD);

              if ((capaianNaik || capaianSama) && kumulatifCukup) {
                grade = "BIRU";
                gradeDesc =
                  "Capaian Bulan ini lebih besar dari atau sama dengan bulan lalu dan kumulatif di atas target";
                gradeClass = "bg-biru";
              } else if (capaianTurun && kumulatifCukup) {
                grade = "HIJAU";
                gradeDesc =
                  "Capaian Bulan ini lebih kecil dari bulan lalu dan kumulatif di atas target";
                gradeClass = "bg-hijau";
              } else if (capaianNaik && !kumulatifCukup) {
                grade = "KUNING";
                gradeDesc =
                  "Capaian Bulan ini lebih besar dari bulan lalu dan kumulatif di bawah target";
                gradeClass = "bg-kuning";
              } else if ((capaianTurun || capaianSama) && !kumulatifCukup) {
                grade = "MERAH";
                gradeDesc =
                  "Capaian Bulan ini lebih kecil dari atau sama dengan bulan lalu dan kumulatif di bawah target";
                gradeClass = "bg-merah";
              }
            }

            rows += `

              <tr>
                <td class="text-center">${counter++}</td>
                <td class="indikator-col text-wrap" style="max-width: 300px;" title="${indikator}">
                  ${indikator}
                </td>
                <td>${isNaN(bulanLaluVal) ? "-" : bulanLaluVal}</td>
                <td>${isNaN(bulanIniVal) ? "-" : bulanIniVal}</td>
                <td>${targetSD}</td>
                <td>${cakupanSD}</td>
                <td class="text-center">${gap}</td>
                <td class="text-center ${trenClass}">${tren}</td>
                <td class="${gradeClass}">${grade}</td>
                <td>
                  <textarea class="form-control form-control-sm" rows="2" style="min-width: 200px">
      ${masalahBulanIni}</textarea>
                </td>
              </tr>
            `;
          });
        }

        tbody.innerHTML = rows;
      }
      function getGrade(capaianBulanIni, capaianBulanLalu, kumulatif, target) {
        const diAtasTarget = kumulatif >= target;
        if (capaianBulanIni > capaianBulanLalu && diAtasTarget) return "biru";
        if (capaianBulanIni === capaianBulanLalu && diAtasTarget) return "biru";
        if (capaianBulanIni < capaianBulanLalu && diAtasTarget) return "hijau";
        if (capaianBulanIni > capaianBulanLalu && !diAtasTarget)
          return "kuning";
        if (capaianBulanIni <= capaianBulanLalu && !diAtasTarget)
          return "merah";
        return ""; // fallback
      }
      document
        .getElementById("bulanSelect")
        .addEventListener("change", function () {
          const bulan = this.value;
          if (bulanKeys.includes(bulan)) {
            selectedBulan = bulan;
            renderTable(originalData, bulan);
          }
        });
    </script>
  </body>
</html>
