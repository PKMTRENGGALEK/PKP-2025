<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Klaster 1 - Managemen</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Tom Select CSS & JS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
      body {
        background: #f0f4f5;
        font-family: "Segoe UI", sans-serif;
      }
      .logo {
        max-height: 100px;
      }
      .table-responsive {
        max-height: 75vh;
        overflow: auto;
      }
      .table th {
        background-color: #198754;
        color: white;
        font-size: 0.72rem;
        text-align: center;
        vertical-align: middle;
      }
      .table td {
        font-size: 0.72rem;
        vertical-align: middle;
      }
      .table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
      }
      .table thead tr:nth-child(2) th {
        top: 36px;
        z-index: 1;
      }

      .bulan-input {
        width: 45px;
        font-size: 0.72rem;
        text-align: center;
      }
      .updated {
        background-color: #d1e7dd !important;
      }
      /* #ttd-section {
        display: none;
      } */
      @media print {
        html,
        body {
          background: white !important;
          color: black !important;
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          height: auto !important;
          width: 100% !important;
          overflow: visible !important;
        }

        /* HAPUS INI: body * { visibility: hidden } */
        /* Ganti dengan ini untuk menyembunyikan hanya elemen di luar #printArea */
        body * {
          visibility: hidden;
        }
        #printArea,
        #printArea * {
          visibility: visible !important;
        }

        /* AREA CETAK */
        #printArea {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          padding: 0 !important;
          margin: 0 !important;
        }

        /* TTD SECTION */
        #ttd-section {
          margin-top: 2cm !important;
          page-break-inside: avoid !important;
          padding-top: 2px;
        }

        /* LAYOUT */
        .container,
        .card,
        .shadow,
        .rounded,
        .border,
        .row,
        .col-6,
        .card-body {
          background: white !important;
          box-shadow: none !important;
          border: none !important;
          overflow: visible !important;
          height: auto !important;
          max-height: none !important;
          page-break-inside: avoid !important;
        }

        .container,
        .row {
          margin: 0 !important;
          padding: 0 !important;
        }

        /* TABEL */
        .table-responsive {
          overflow: visible !important;
          height: auto !important;
          max-height: none !important;
        }

        .table-responsive > table,
        table {
          width: 100% !important;
          page-break-inside: avoid !important;
          break-inside: avoid !important;
        }

        thead {
          display: table-header-group !important;
        }

        tfoot {
          display: table-footer-group !important;
        }

        tr,
        td,
        th {
          page-break-inside: auto !important;
        }

        /* JUDUL */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          margin: 0 !important;
          padding: 0 !important;
          line-height: 1.2 !important;
        }

        /* GAMBAR */
        img {
          max-width: 100% !important;
          page-break-inside: avoid !important;
        }

        /* TTD ABSOLUTE */
        #ttdPenanggungJawab {
          position: absolute !important;
          bottom: 25px !important;
          left: 25% !important;
          transform: translateX(-50%) !important;
          height: 80px !important;
          opacity: 0.9 !important;
        }

        #ttdPelaksana {
          position: absolute !important;
          bottom: +30px !important;
          left: 50% !important;
          transform: translateX(-50%) !important;
          height: 80px !important;
          opacity: 0.9 !important;
        }

        /* NON PRINT */
        .no-print {
          display: none !important;
        }

        /* UKURAN KERTAS */
        @page {
          size: A4 landscape;
          margin: 1cm;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid py-4" style="max-width: 95%; margin: auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-center mb-4">
            <!-- <img
          src="https://puskesmastrenggalek.github.io/SIP/assets/pkm.png"
          alt="Logo"
          style="max-height: 80px"
          class="mb-2"
        /> -->
            <h4 class="fw-bold mb-0">CAPAIAN KEGIATAN KLASTER MANAJEMEN</h4>
          </div>

          <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="home.html" class="btn btn-outline-success shadow-sm"
              >‚¨ÖÔ∏è Kembali</a
            >
            <div>
              <div class="text-end mb-3">
                <button
                  class="btn btn-outline-danger no-print"
                  data-bs-toggle="modal"
                  data-bs-target="#modalPenanggungJawab"
                >
                  üñ®Ô∏è Cetak PDF
                </button>
              </div>
              <button id="saveAllBtn" class="btn btn-success shadow-sm">
                üíæ Simpan Semua
              </button>
            </div>
          </div>
          <!-- modal penaggung jawab -->
          <div class="modal fade" id="modalPenanggungJawab" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Pilih Penanggung Jawab</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <select class="form-select" id="selectPenanggungJawab">
                    <option value="" selected disabled>-- Pilih --</option>

                    <option
                      value="dr. MURTI RUKIYANDARI|19800611 200903 2 004|assets/kapus.png|Kepala Puskesmas"
                    >
                      dr. MURTI RUKIYANDARI
                    </option>
                    <option
                      value="drg. DIAN SITA RISTIANA|19821022 201001 2 014|assets/diansita.png|PJ Lintas Klaster"
                    >
                      drg. DIAN SITA RISTIANA
                    </option>
                    <option
                      value="dr. Melissa Teguh|19870519 202203 2 002|assets/melisa.png|PJ Klaster 4"
                    >
                      dr. Melissa Teguh
                    </option>
                    <option
                      value="ASTUTIK, S.S.T.|19721011 199301 2 001|assets/astutik.png|PJ Klaster 2"
                    >
                      ASTUTIK, S.S.T.
                    </option>

                    <option
                      value="HAYUNING DEWI OCTAVIANTI, S.K.M.|19801003 200604 2 022|assets/hayuning.png|PJ Klaster 1"
                    >
                      HAYUNING DEWI OCTAVIANTI, S.K.M.
                    </option>

                    <option
                      value="DINA ANINGGARWATI, Amd.Kep.|19821208 201406 2 003|assets/dina.png|PJ Klaster 3"
                    >
                      DINA ANINGGARWATI, Amd.Kep.
                    </option>
                    <option
                      value="Nurkolis S.Kep Ns|19780611 199803 1 005|assets/nurkolis.png|PJ Klaster 4"
                    >
                      Nurkolis S.Kep Ns
                    </option>
                    
                  </select>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Batal
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="pilihPJDanCetak()"
                  >
                    OK & Cetak
                  </button>
                </div>
              </div>
            </div>
          </div>
          <br />
          <div id="printArea">
            <div class="table-responsive">
              <table
                class="table table-bordered table-striped align-middle"
                id="programTable"
              >
                <thead class="table-success text-center align-middle">
                  <tr>
                    <th rowspan="2">No</th>
                    <th rowspan="2" style="min-width: 120px">Jenis Variabel</th>
                    <th rowspan="2" style="min-width: 250px">
                      Definisi Operasional
                    </th>
                    <th rowspan="2">0</th>
                    <th rowspan="2">4</th>
                    <th rowspan="2">7</th>
                    <th rowspan="2">10</th>
                    <th rowspan="2">Target</th>
                    <th rowspan="2">Capaian</th>
                    <th rowspan="2">Ketercapaian</th>
                    <th colspan="4">Capaian Kegiatan Program</th>
                    <th rowspan="2">Link</th>
                  </tr>
                  <tr class="text-center">
                    <th>Triwulan I</th>
                    <th>Triwulan II</th>
                    <th>Triwulan III</th>
                    <th>Triwulan IV</th>
                  </tr>
                </thead>
                <tbody id="tableBody">
                  <tr>
                    <td colspan="15" class="text-center">Memuat data...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row" id="ttd-section">
              <div id="ttd-section" class="mt-2" style="margin-top: 2px">
                <div class="row text-center" style="font-size: 0.9rem">
                  <!-- Penanggung Jawab -->
                  <div class="col-6">
                    <!-- Penanggung Jawab -->
                    <p class="mb-0">Mengetahui,<br />PJ Klaster 1 Manajemen</p>
                    <!-- id="ttdPelaksana" -->
                    <img
                      id="ttdPenanggungJawab"
                      src="assets/hayuning.png"
                      alt="TTD Pelaksana"
                      style="
                        position: absolute;
                        bottom: 29px; /* Agar gambar turun ke arah nama */
                        left: 25%;
                        transform: translateX(-50%);
                        height: 80px;
                        opacity: 0.9;
                      "
                    />
                    <br /><br /><br />
                    <p
                      id="namaPenanggungJawab"
                      class="fw-bold text-decoration-underline mb-1"
                    >
                      Hayuning Dewi Octavianti S.KM
                    </p>
                    <p id="nipPenanggungJawab" class="mb-0">
                      NIP. 19801003 200604 2 022
                    </p>
                  </div>
                  <!-- Pelaksana -->
                  <div class="col-6 position-relative" style="height: 120px">
                    <p class="mb-0"><br />Pelaksana,</p>
                    <!-- Gambar tanda tangan transparan -->
                    <img
                      id="ttdPelaksana"
                      src="assets/ttd_pelaksana.png"
                      alt="TTD Pelaksana"
                      style="
                        position: absolute;
                        bottom: -10px; /* Agar gambar turun ke arah nama */
                        left: 50%;
                        transform: translateX(-50%);
                        height: 80px;
                        opacity: 0.9;
                      "
                    />
                    <br /><br /><br />
                    <p
                      id="namaPelaksana"
                      class="fw-bold text-decoration-underline mb-1"
                    >
                      ..........................................
                    </p>
                    <p id="nipPelaksana" class="mb-0">
                      NIP. ..........................................
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      const endpoint =
        "https://script.google.com/macros/s/AKfycbzg84-rK9Grl_7-89tbqoXR_H5CSXyBcd45sE4zwEXSxn_DIxwP-ERWu2GaH6lDC9-S/exec";
      let grouped = {};

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function loadData() {
        fetch(endpoint)
          .then((res) => res.json())
          .then((data) => {
            const selectedFromURL = getQueryParam("program");
            if (!selectedFromURL) {
              document.getElementById("tableBody").innerHTML = `
            <tr><td colspan="15" class="text-center text-muted">Tidak ada data ditampilkan. Parameter <code>?program=</code> diperlukan.</td></tr>`;
              return;
            }

            const klaster1Data = data.filter((item) =>
              item.Program?.toLowerCase().startsWith("1.")
            );

            grouped = {};
            klaster1Data.forEach((row) => {
              const program = row.Program || "Lainnya";
              if (!grouped[program]) grouped[program] = [];
              grouped[program].push(row);
            });

            if (!grouped[selectedFromURL]) {
              document.getElementById("tableBody").innerHTML = `
            <tr><td colspan="15" class="text-danger text-center">Program <strong>${selectedFromURL}</strong> tidak ditemukan.</td></tr>`;
              return;
            }

            renderTable(selectedFromURL);
          })
          .catch((error) => {
            document.getElementById("tableBody").innerHTML = `
          <tr><td colspan="15" class="text-danger text-center">Gagal memuat data.</td></tr>`;
            console.error("Fetch error:", error);
          });
      }

      function renderTable(selectedProgram) {
        const tableBody = document.getElementById("tableBody");

        tableBody.innerHTML = `
      <tr id="loadingRow">
        <td colspan="15" class="text-center py-4">
          <div class="spinner-border text-success" role="status"></div>
          <div class="mt-2 text-success fw-semibold">Memuat data...</div>
        </td>
      </tr>`;

        setTimeout(() => {
          let index = 1;
          const rows = grouped[selectedProgram];
          if (!rows || rows.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="15" class="text-center">Tidak ada data.</td></tr>`;
            return;
          }

          tableBody.innerHTML = `<tr style="background-color:#d1e7dd">
        <td colspan="15"><strong>üìå ${selectedProgram}</strong></td></tr>`;

          const jenisMap = {};
          rows.forEach((row, i) => {
            const jenis = row["Jenis Variabel"] || "-";
            if (!jenisMap[jenis]) {
              jenisMap[jenis] = { startIndex: i, count: 1 };
            } else {
              jenisMap[jenis].count++;
            }
          });

          rows.forEach((row, i) => {
            const rowId = row["No"];
            const jenis = row["Jenis Variabel"] || "-";
            const jenisInfo = jenisMap[jenis];
            const isFirstRow = jenisInfo.startIndex === i;

            let html = `<tr data-id="${rowId}">`;
            html += `<td>${index++}</td>`;
            if (isFirstRow) {
              html += `<td rowspan="${jenisInfo.count}">${jenis}</td>`;
            }

            const capaianMax = hitungMax(row);
            const target = row["Target Nilai Kinerja"];
            const ketercapaian = hitungKetercapaian(capaianMax, target);

            html += `
              <td>${row["Definisi Operasional"] || "-"}</td>
              <td>${row["0"] || "-"}</td>
              <td>${row["4"] || "-"}</td>
              <td>${row["7"] || "-"}</td>
              <td>${row["10"] || "-"}</td>
              <td>${target || "-"}</td>
              <td class="capaian">${capaianMax}</td>
              <td class="ketercapaian">${ketercapaian}</td>
              ${renderEditableCell("Triwulan I", rowId, row["Triwulan I"])}
              ${renderEditableCell("Triwulan II", rowId, row["Triwulan II"])}
              ${renderEditableCell("Triwulan III", rowId, row["Triwulan III"])}
              ${renderEditableCell("Triwulan IV", rowId, row["Triwulan IV"])}
              <td>${
                row["Link"]
                  ? `<a href="${row["Link"]}" target="_blank" class="btn btn-outline-primary btn-sm shadow">
                  <i class="bi bi-link-45deg"></i> 
                </a>`
                  : "-"
              }</td>
            </tr>`;

            tableBody.innerHTML += html;

            const url = `${endpoint}?action=updateCapaian&id=${encodeURIComponent(
              rowId
            )}&value=${encodeURIComponent(capaianMax)}`;
            fetch(url).catch((err) =>
              console.error("Gagal update capaian:", err)
            );
          });

          // Tandai perubahan input
          $(".bulan-input").on("input", function () {
            const input = $(this);
            const nilaiBaru = input.val().trim();
            const nilaiLama = input.data("old");

            if (nilaiBaru !== nilaiLama) {
              input.addClass("updated");
            } else {
              input.removeClass("updated");
            }
          });
        }, 300);
      }

      function hitungMax(row) {
        const bulan = ["Triwulan I", "Triwulan II", "Triwulan III"];
        const angka = bulan
          .map((b) => parseFloat(row[b]))
          .filter((n) => !isNaN(n));
        return angka.length > 0 ? Math.max(...angka) : "-";
      }

      function hitungKetercapaian(capaian, target) {
        const cap = parseFloat(capaian);
        const tar = parseFloat(target);
        if (isNaN(cap) || isNaN(tar) || tar === 0) return "-";
        const persen = (cap / tar) * 100;
        return persen.toFixed(1) + "%";
      }

      function renderEditableCell(bulan, id, value) {
        return `<td class="text-center">
      <input type="text" class="form-control form-control-sm bulan-input"
        data-bulan="${bulan}" data-id="${id}" data-old="${value || ""}"
        value="${value || ""}" />
    </td>`;
      }

      function saveAllData() {
        const inputs = $(".bulan-input.updated");
        if (inputs.length === 0) {
          Swal.fire(
            "Tidak ada perubahan",
            "Belum ada data yang diubah.",
            "info"
          );
          return;
        }

        Swal.fire({
          title: "Menyimpan semua...",
          html: `<div class="text-start">Menyimpan <b>${inputs.length}</b> perubahan...</div>`,
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        let promises = [];

        inputs.each(function () {
          const input = $(this);
          const id = input.data("id");
          const bulan = input.data("bulan");
          const nilai = input.val().trim();

          if (!/^\d+$/.test(nilai)) {
            Swal.fire("Input tidak valid", "Masukkan angka saja.", "warning");
            return;
          }

          const url = `${endpoint}?action=update&id=${encodeURIComponent(
            id
          )}&bulan=${encodeURIComponent(bulan)}&nilai=${encodeURIComponent(
            nilai
          )}`;

          const promise = fetch(url)
            .then((res) => res.json())
            .then((res) => {
              if (res.success) {
                input.removeClass("updated").data("old", nilai);

                const tr = input.closest("tr");
                const bulanKeys = ["Triwulan I", "Triwulan II", "Triwulan III"];
                const nilaiBulan = bulanKeys.map(
                  (b) => parseFloat(tr.find(`[data-bulan="${b}"]`).val()) || 0
                );
                const capaianBaru = Math.max(...nilaiBulan);

                const capaianURL = `${endpoint}?action=updateCapaian&id=${encodeURIComponent(
                  id
                )}&value=${encodeURIComponent(capaianBaru)}`;
                fetch(capaianURL).catch((err) =>
                  console.error("Gagal update capaian max:", err)
                );

                tr.find(".capaian").text(capaianBaru);
                const target =
                  parseFloat(tr.find("td:nth-child(8)").text()) || 0;
                const ketercapaian =
                  target === 0
                    ? "-"
                    : ((capaianBaru / target) * 100).toFixed(1) + "%";
                tr.find(".ketercapaian").text(ketercapaian);
              } else {
                throw new Error("Gagal menyimpan: " + res.message);
              }
            });

          promises.push(promise);
        });

        Promise.all(promises)
          .then(() => {
            Swal.close();
            Swal.fire(
              "Berhasil",
              "Semua perubahan berhasil disimpan.",
              "success"
            );
          })
          .catch((err) => {
            Swal.close();
            Swal.fire(
              "Gagal",
              err.message || "Gagal menyimpan sebagian data",
              "error"
            );
          });
      }

      $(document).ready(function () {
        $("#saveAllBtn").on("click", saveAllData);
      });

      loadData();
    </script>
    <!-- ambil parameter nama dari url -->
    <script>
      // Ambil parameter dari URL
      function getParameterByName(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name) || "";
      }

      // Ambil nama
      const namaPelaksana = getParameterByName("nama");
      if (namaPelaksana) {
        document.getElementById("namaPelaksana").textContent = namaPelaksana;
      }

      // Ambil NIP
      const nipPelaksana = getParameterByName("nip");
      if (nipPelaksana) {
        document.getElementById("nipPelaksana").textContent =
          "NIP. " + nipPelaksana;
      }

      // Ambil gambar tanda tangan (nama file saja, misal: hayuning.png)
      const imgPelaksana = getParameterByName("img");
      if (imgPelaksana) {
        document.getElementById("ttdPelaksana").src = "assets/" + imgPelaksana;
      }
    </script>

    <!-- print btn  -->
    <script>
      document
        .getElementById("btnPrint")
        .addEventListener("click", function () {
          const printContent = document.createElement("div");

          const tableClone = document
            .querySelector(".table-responsive")
            .cloneNode(true);
          const ttdClone = document
            .getElementById("ttd-section")
            .cloneNode(true);

          printContent.appendChild(tableClone);
          printContent.appendChild(ttdClone);

          const opt = {
            margin: 0.5,
            filename: `Analisa_PKP_${
              new Date().toISOString().split("T")[0]
            }.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              allowTaint: true,
            },
            jsPDF: {
              unit: "in",
              format: "a4",
              orientation: "landscape",
            },
          };

          html2pdf().set(opt).from(printContent).save();
        });
    </script>
    <script>
      function pilihPJDanCetak() {
        const select = document.getElementById("selectPenanggungJawab");
        const selectedValue = select.value;

        if (!selectedValue) {
          alert("Silakan pilih Penanggung Jawab terlebih dahulu.");
          return;
        }

        const [nama, nip] = selectedValue.split("|");

        // Update tampilan di halaman
        document.getElementById("namaPenanggungJawab").textContent = nama;
        document.getElementById("nipPenanggungJawab").textContent =
          "NIP. " + nip;

        // Tutup modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("modalPenanggungJawab")
        );
        modal.hide();

        // Delay sedikit agar modal sempat hilang dulu
        setTimeout(() => {
          window.print();
        }, 300);
      }
    </script>
    <!-- tom select -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        new TomSelect("#selectPenanggungJawab", {
          create: false,
          sortField: {
            field: "text",
            direction: "asc",
          },
          placeholder: "Ketik untuk mencari nama...",
        });
      });
    </script>
  </body>
</html>
