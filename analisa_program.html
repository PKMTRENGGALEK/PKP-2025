<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Detail Klaster</title>

    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Select2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    />

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Tom Select CSS & JS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <style>
      body {
        background: #f0f4f5;
        font-family: "Segoe UI", sans-serif;
      }
      @media print {
        html,
        body {
          background: white !important;
          color: black !important;
          margin: 0 !important;
          padding: 0 !important;
          box-shadow: none !important;
          -webkit-print-color-adjust: exact !important;
          print-color-adjust: exact !important;
          height: auto !important;
          width: 100% !important;
          overflow: visible !important;
        }

        /* SEMUA DISEMBUNYIKAN TERLEBIH DULU */
        body * {
          visibility: hidden !important;
        }

        /* H1-H6 BERSIH DARI MARGIN DAN PADDING */
        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
          margin: 0 !important;
          padding: 0 !important;
          line-height: 1.2 !important;
        }

        /* JUDUL PRINT */
        .judul-print {
          margin: 0 !important;
          padding: 0 !important;
          line-height: 1.2 !important;
          visibility: visible !important;
        }

        /* AREA CETAK */
        #printArea {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          visibility: visible !important;
          padding: 0 !important;
          margin: 0 !important;
        }

        #printArea * {
          visibility: visible !important;
          margin: 0 !important;
          padding: 0 !important;
        }

        /* NON-PRINT */
        .no-print {
          display: none !important;
        }

        /* LAYOUT */
        .container,
        .card,
        .shadow,
        .rounded,
        .border,
        .row,
        .col-6,
        .card-body {
          background: white !important;
          box-shadow: none !important;
          border: none !important;
          overflow: visible !important;
          height: auto !important;
          max-height: none !important;
          page-break-inside: avoid !important;
        }

        /* TABEL */
        .table-responsive {
          overflow: visible !important;
          height: auto !important;
          max-height: none !important;
        }

        .table-responsive > table,
        table {
          width: 100% !important;
          page-break-inside: avoid !important;
          break-inside: avoid !important;
        }

        thead {
          display: table-header-group !important;
        }

        tfoot {
          display: table-footer-group !important;
        }

        tr,
        td,
        th {
          page-break-inside: auto !important;
        }

        /* GAMBAR */
        img {
          max-width: 100% !important;
          page-break-inside: avoid !important;
        }

        /* AREA KHUSUS */
        #ttd-section {
          page-break-inside: avoid !important;
        }
        .container,
        .row {
          margin: 0 !important;
          padding: 0 !important;
        }
        .table thead tr:nth-child(1) th,
        .table thead tr:nth-child(2) th {
          position: static !important;
          top: auto !important;
          z-index: auto !important;
        }
        /* #printArea * {
          border: 1px dashed red;
        } */
        /* UKURAN KERTAS */
        @page {
          size: A4 landscape;
          margin: 1cm;
        }
      }

      @media screen {
        #ttd-section {
          display: none;
        }
      }
      .logo {
        max-height: 100px;
      }

      .table-responsive {
        position: relative;
        max-height: 75vh;
        overflow: auto;
      }

      .table th,
      .table thead th {
        background-color: #198754 !important;
        color: white !important;
        font-size: 0.72rem;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
      }

      .table td {
        font-size: 0.72rem;
        vertical-align: middle;
        white-space: nowrap;
      }

      /* Sticky headers */
      .table thead tr:nth-child(1) th {
        position: sticky;
        top: 0;
        z-index: 3;
      }

      .table thead tr:nth-child(2) th {
        position: sticky;
        top: 34px;
        z-index: 2;
      }

      .bulan-input {
        width: 45px;
        font-size: 0.72rem;
        text-align: center;
      }

      .updated {
        background-color: #d1e7dd !important;
      }
      th.indikator-col,
      td.indikator-col {
        max-width: 700px; /* Ubah sesuai kebutuhan, misalnya 150px */
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
      }

      .bg-biru {
        background-color: #2196f3;
        color: white;
      }
      .bg-hijau {
        background-color: #4caf50;
        color: white;
      }
      .bg-kuning {
        background-color: #ffeb3b;
        color: black;
      }
      .bg-merah {
        background-color: #f44336;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid py-4" style="max-width: 95%; margin: auto">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="text-center mb-4"></div>

          <div class="d-flex justify-content-start mb-3">
            <a
              href="home.html"
              class="btn btn-outline-success shadow-sm no-print"
              >‚¨ÖÔ∏è Kembali</a
            >
          </div>

          <div class="mb-3">
            <label for="bulanSelect" class="form-label fw-bold no-print"
              >Pilih Bulan:</label
            >
            <select
              id="bulanSelect"
              class="form-select form-select-sm no-print"
              style="max-width: 200px"
            >
              <option value="Juli">Semua Bulan</option>
              <!-- default tampil semua bulan dengan bulan ini = "Juli" -->
              <option value="Jan">Januari</option>
              <option value="Feb">Februari</option>
              <option value="Mar">Maret</option>
              <option value="Apr">April</option>
              <option value="Mei">Mei</option>
              <option value="Juni">Juni</option>
              <option value="Juli">Juli</option>
              <option value="Agst">Agustus</option>
              <option value="Sept">September</option>
              <option value="Okt">Oktober</option>
              <option value="Nov">November</option>
              <option value="Des">Desember</option>
            </select>
          </div>
          <!-- Filter kategori -->
          <div class="mb-3 d-none">
            <label for="kategoriSelect" class="form-label fw-bold"
              >Pilih kategori:</label
            >
            <select
              id="kategoriSelect"
              class="form-select form-select-sm"
              style="max-width: 300px"
            >
              <option value="Semua">Semua kategori</option>
            </select>
          </div>

          <div class="text-end mt-3 mb-2">
            <button class="btn btn-success no-print" id="simpanMasalah">
              Simpan Perubahan
            </button>
          </div>

          <div class="text-end mb-3">
            <button
              class="btn btn-outline-danger no-print"
              data-bs-toggle="modal"
              data-bs-target="#modalPenanggungJawab"
            >
              üñ®Ô∏è Cetak PDF
            </button>
          </div>

          <!-- Modal Pilih Penanggung Jawab -->
          <div class="modal fade" id="modalPenanggungJawab" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title">Pilih Penanggung Jawab</h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"
                  ></button>
                </div>
                <div class="modal-body">
                  <select class="form-select" id="selectPenanggungJawab">
                    <option value="" selected disabled>-- Pilih --</option>
                    <option
                      value="dr. TATIK SUKARYATI|19710611 200212 2 006|ttd1"
                    >
                      dr. TATIK SUKARYATI
                    </option>
                    <option
                      value="dr. MURTI RUKIYANDARI|19800611 200903 2 004|ttd2"
                    >
                      dr. MURTI RUKIYANDARI
                    </option>
                    <option
                      value="drg. DIAN SITA RISTIANA|19821022 201001 2 014"
                    >
                      drg. DIAN SITA RISTIANA
                    </option>
                    <option value="ASTUTIK, S.S.T.|19721011 199301 2 001">
                      ASTUTIK, S.S.T.
                    </option>
                    <option
                      value="DEWI ANDRIKA ASMARA, S.Gz.|19860807 200903 2 013"
                    >
                      DEWI ANDRIKA ASMARA, S.Gz.
                    </option>
                    <option
                      value="HAYUNING DEWI OCTAVIANTI, S.K.M.|19801003 200604 2 022"
                    >
                      HAYUNING DEWI OCTAVIANTI, S.K.M.
                    </option>
                    <option value="PARYATI, Amd.Keb.|19700629 199102 2 003">
                      PARYATI, Amd.Keb.
                    </option>
                    <option value="MUBINAH, Amd.Keb.|19701220 199102 2 002">
                      MUBINAH, Amd.Keb.
                    </option>
                    <option
                      value="LILIK SUSANTI, Amd.Keb|19700304 199203 2 005"
                    >
                      LILIK SUSANTI, Amd.Keb
                    </option>
                    <option value="SETIYANI, A.Md.Farm.|19680101 199203 2 018">
                      SETIYANI, A.Md.Farm.
                    </option>
                    <option
                      value="NINIK WARDIATI, Amd.Keb.|19730404 199302 2 003"
                    >
                      NINIK WARDIATI, Amd.Keb.
                    </option>
                    <option
                      value="ENY KARYAWATI, Amd.Keb.|19710624 199302 2 001"
                    >
                      ENY KARYAWATI, Amd.Keb.
                    </option>
                    <option value="NURKOLIS, A.Md.Kep.|19780611 199803 1 005">
                      NURKOLIS, A.Md.Kep.
                    </option>
                    <option value="SUPRIJONO, A.Md.Kep.|19680501 199003 1 009">
                      SUPRIJONO, A.Md.Kep.
                    </option>
                    <option value="WINDAYANI, S.S.T.|19760426 200501 2 010">
                      WINDAYANI, S.S.T.
                    </option>
                    <option
                      value="Ns. SELIYA CITRA PRATIWI, S.Kep.|19841029 201001 2 019"
                    >
                      Ns. SELIYA CITRA PRATIWI, S.Kep.
                    </option>
                    <option value="MARJIANTO, Amd.Gz.|19720118 199203 1 009">
                      MARJIANTO, Amd.Gz.
                    </option>
                    <option
                      value="YUYUN WAHYU RETNOWATI, Amd.Keb.|19780302 200801 2 017"
                    >
                      YUYUN WAHYU RETNOWATI, Amd.Keb.
                    </option>
                    <option
                      value="DHEARARA WIDHIAYU RIZKY, S.Farm.,Apt.|19950506 201903 2 005"
                    >
                      DHEARARA WIDHIAYU RIZKY, S.Farm.,Apt.
                    </option>
                    <option
                      value="RUDY KURNIAWAN, A.Md.K.L.|19771107 200903 1 004"
                    >
                      RUDY KURNIAWAN, A.Md.K.L.
                    </option>
                    <option
                      value="WILDA HAYYIN NAFI'AH, A.Md. Farm.|19861201 201101 2 016"
                    >
                      WILDA HAYYIN NAFI'AH, A.Md. Farm.
                    </option>
                    <option value="TITIK SUWANTI, A.Md.|19800408 201101 2 011">
                      TITIK SUWANTI, A.Md.
                    </option>
                    <option
                      value="BEKTI KUSUMADEWI, S.Kep.Ns.|19880706 201903 2 004"
                    >
                      BEKTI KUSUMADEWI, S.Kep.Ns.
                    </option>
                    <option
                      value="ANIK HARYATI, A.Md.Kes.|19790817 200701 2 014"
                    >
                      ANIK HARYATI, A.Md.Kes.
                    </option>
                    <option
                      value="AGUS WAHYONO, Amd.Kep.|19730821 200604 1 008"
                    >
                      AGUS WAHYONO, Amd.Kep.
                    </option>
                    <option value="dr. VIGA RESFIKASARI|19920411 202203 2 001">
                      dr. VIGA RESFIKASARI
                    </option>
                    <option
                      value="dr. GERALDI KUSUMA WIJAYA|19940723 202203 1 002"
                    >
                      dr. GERALDI KUSUMA WIJAYA
                    </option>
                    <option
                      value="LURUH SETYORESMI, S.Gz.|19900618 201903 2 001"
                    >
                      LURUH SETYORESMI, S.Gz.
                    </option>
                    <option
                      value="DINA ANINGGARWATI, Amd.Kep.|19821208 201406 2 003|ttd29"
                    >
                      DINA ANINGGARWATI, Amd.Kep.
                    </option>
                    <option
                      value="RATNA DEWI KUSTANTI, A.Md.Keb.|19760606 200801 2 036"
                    >
                      RATNA DEWI KUSTANTI, A.Md.Keb.
                    </option>
                    <option
                      value="DENY WAHYU PURNOMO, Amd.Kep.|19780615 200701 1 023"
                    >
                      DENY WAHYU PURNOMO, Amd.Kep.
                    </option>
                    <option
                      value="SHEVI DWI ARDHIANI, S.KM|19930916 202012 2 004"
                    >
                      SHEVI DWI ARDHIANI, S.KM
                    </option>
                    <option
                      value="FARHANI PUTRI MUNGGARANI, S.KM|19880410 202203 2 002"
                    >
                      FARHANI PUTRI MUNGGARANI, S.KM
                    </option>
                    <option
                      value="DEWI NOVITASARI, Amd.Keb.|19791120 201905 2 001"
                    >
                      DEWI NOVITASARI, Amd.Keb.
                    </option>
                    <option
                      value="RIA DWI YUSIANTI, A.Md.|19890109 201903 2 005"
                    >
                      RIA DWI YUSIANTI, A.Md.
                    </option>
                    <option
                      value="BELLA NURVITASARI, A.Md.Kes.|19970526 201903 2 001"
                    >
                      BELLA NURVITASARI, A.Md.Kes.
                    </option>
                    <option
                      value="BETY NARISWARI AZIZAH, A.Md.RMIK|19931023 201903 2 012"
                    >
                      BETY NARISWARI AZIZAH, A.Md.RMIK
                    </option>
                    <option
                      value="ANJAR TRI CAHYANINGSIH, Amd.Kep|19910415 202012 2 003"
                    >
                      ANJAR TRI CAHYANINGSIH, Amd.Kep
                    </option>
                    <option value="NURJANAH, Amd.Kep|19880514 202012 2 002">
                      NURJANAH, Amd.Kep
                    </option>
                    <option
                      value="NOVITA ANGGRAINI, Amd.AK|19921104 202012 2 005"
                    >
                      NOVITA ANGGRAINI, Amd.AK
                    </option>
                    <option
                      value="MARATUS SOLIKAH, Amd.K.G|19900323 202012 2 002"
                    >
                      MARATUS SOLIKAH, Amd.K.G
                    </option>
                    <option
                      value="MUFIDATUL MUNAWAROH, Amd.AK|19930216 202012 2 006"
                    >
                      MUFIDATUL MUNAWAROH, Amd.AK
                    </option>
                    <option
                      value="DWIYANTI PRA SETYANINGSIH, A.Md.Kep.|19980123 202203 2 003"
                    >
                      DWIYANTI PRA SETYANINGSIH, A.Md.Kep.
                    </option>
                    <option
                      value="OKTARINA FADLILAH, A.Md.Kep.|19971030 202203 2 007"
                    >
                      OKTARINA FADLILAH, A.Md.Kep.
                    </option>
                    <option
                      value="FITRIA RAHMAWATI, A.Md.Keb.|19950302 202203 2 003"
                    >
                      FITRIA RAHMAWATI, A.Md.Keb.
                    </option>
                    <option
                      value="MUJAHIDAH FIDIENIA HARLIANI, A.Md.Gz.|19950324 202203 2 005"
                    >
                      MUJAHIDAH FIDIENIA HARLIANI, A.Md.Gz.
                    </option>
                    <option
                      value="FAQIH AMRULLOH HUSEIN, A.Md.Kes.|19990610 202203 1 003"
                    >
                      FAQIH AMRULLOH HUSEIN, A.Md.Kes.
                    </option>
                    <option
                      value="RIZQI ERY ISYADI, A.Md.|19960530 202203 1 005"
                    >
                      RIZQI ERY ISYADI, A.Md.
                    </option>
                    <option
                      value="Ns.TANJUNG PANJI ASMORO, S.Kep|199206262023211001"
                    >
                      Ns.TANJUNG PANJI ASMORO, S.Kep
                    </option>
                    <option value="ADHITA AYU AGUSTIN, SKM|199608292023212001">
                      ADHITA AYU AGUSTIN, SKM
                    </option>
                    <option
                      value="DWIHAYU PRASTYANDARTI, A.Md.Kep.|198210202022212001"
                    >
                      DWIHAYU PRASTYANDARTI, A.Md.Kep.
                    </option>
                    <option value="LISA ENDRIENI, A.Md.Kep.|198701262022212001">
                      LISA ENDRIENI, A.Md.Kep.
                    </option>
                    <option value="YANU PRASETYO, A.Md.Kep.|198401202022211001">
                      YANU PRASETYO, A.Md.Kep.
                    </option>
                    <option
                      value="WAHYU PUJI LESTARI, A.Md.Keb.|199010042022212002"
                    >
                      WAHYU PUJI LESTARI, A.Md.Keb.
                    </option>
                    <option
                      value="TATIK SRISETYO RAHAYU, Amd,Kep|198210162023212002"
                    >
                      TATIK SRISETYO RAHAYU, Amd,Kep
                    </option>
                    <option
                      value="LINDA DWI RAHAYU SETYARINI, Amd.Kep|198602122023212003"
                    >
                      LINDA DWI RAHAYU SETYARINI, Amd.Kep
                    </option>
                  </select>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                  >
                    Batal
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    onclick="pilihPJDanCetak()"
                  >
                    OK & Cetak
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Awal Print Area -->
          <div id="printArea">
            <!-- <div class="judul-print">
              <h2>IDENTIFIKASI DAN ANALISA MASALAH PKP 2025</h2>
            </div> -->

            <div class="table-wrapper">
              <div class="table-responsive">
                <table
                  class="table table-bordered table-striped table-hover align-middle text-nowrap"
                  id="programTable"
                >
                  <thead class="table-success text-center align-middle">
                    <tr>
                      <th rowspan="2">No</th>
                      <th rowspan="2" width="300px">Indikator Kerja</th>
                      <th colspan="2">Bulan</th>
                      <th
                        rowspan="2"
                        id="targetHeader"
                        width="70px"
                        class="text-wrap"
                      >
                        % Target s/d Bulan ...
                      </th>
                      <th rowspan="2" width="70px" class="text-wrap">
                        % CAKUPAN s/d Bulan <span id="cakupanBulan">...</span>
                      </th>
                      <th
                        rowspan="2"
                        id="kesenjangan"
                        width="60px"
                        class="text-wrap"
                      >
                        % Kesenjangan
                      </th>
                      <th rowspan="2" id="Tren" width="70px" class="text-wrap">
                        TREN
                      </th>
                      <th rowspan="2" width="30px">Grade</th>
                      <th rowspan="2" width="220px" class="text-wrap">
                        Masalah
                      </th>
                      <th rowspan="2" width="220px" class="text-wrap">
                        Analisa Penyebab Masalah
                      </th>
                      <th rowspan="2" width="220px" class="text-wrap">
                        Rencana Tindak Lanjut
                      </th>
                      <th rowspan="2" width="220px" class="text-wrap">
                        Hasil Tindak Lanjut
                      </th>
                    </tr>
                    <tr>
                      <th>Bulan Lalu</th>
                      <th>Bulan Ini</th>
                    </tr>
                  </thead>
                  <tbody id="tableBody">
                    <tr>
                      <td colspan="25" class="text-center">Memuat data...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <!-- Tanda Tangan (TTD) -->
            <div id="ttd-section" class="mt-4">
              <div class="row text-center" style="font-size: 0.9rem">
                <!-- Penanggung Jawab -->
                <div class="col-6">
                  <!-- Penanggung Jawab -->
                  <p class="mb-0">Mengetahui,<br />Penanggung Jawab</p>
                  <!-- <img
                    id="ttdPenanggungJawab"
                    src="img/ttd_murti.png"
                    alt="TTD PJ"
                    style="max-height: 60px; margin: 10px 0; opacity: 0.8"
                  /> -->
                  <br /><br /><br />
                  <p
                    id="namaPenanggungJawab"
                    class="fw-bold text-decoration-underline mb-1"
                  >
                    dr. Murti Rukiyandari
                  </p>
                  <p id="nipPenanggungJawab" class="mb-0">
                    NIP. 19780910 200604 2 001
                  </p>
                </div>
                <!-- Pelaksana -->
                <div class="col-6">
                  <p class="mb-0"><br />Pelaksana,</p>
                  <!-- Gambar tanda tangan transparan -->
                  <!-- <img
                    id="ttdPelaksana"
                    src="img/ttd_pelaksana.png"
                    alt="TTD Pelaksana"
                    style="max-height: 60px; margin: 10px 0; opacity: 0.8"
                  /> -->
                  <br /><br /><br />
                  <p
                    id="namaPelaksana"
                    class="fw-bold text-decoration-underline mb-1"
                  >
                    ..........................................
                  </p>
                  <p id="nipPelaksana" class="mb-0">
                    NIP. ..........................................
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- Akhir Print Area -->

          <div class="mb-3 mt-2 no-print">
            <h6 class="fw-bold">Keterangan Warna Grade:</h6>
            <ul class="list-unstyled" style="font-size: 10px">
              <li>
                <span class="badge bg-primary text-white">BIRU</span> : jika
                <strong>Capaian Bulan ini lebih besar</strong> dari bulan lalu
                dan kumulatif di atas target
              </li>
              <li class="mt-2">
                <span class="badge bg-primary text-white">BIRU</span>
                : jika <strong>Capaian Bulan ini sama</strong> dengan bulan lalu
                dan kumulatif di atas target
              </li>
              <li class="mt-2">
                <span class="badge bg-success text-white">HIJAU</span> : jika
                <strong>Capaian Bulan ini lebih kecil</strong> dari bulan lalu
                dan kumulatif di atas target
              </li>
              <li class="mt-2">
                <span class="badge bg-warning text-dark">KUNING</span> : jika
                <strong>Capaian Bulan ini lebih besar</strong> dari bulan lalu
                dan kumulatif di bawah target
              </li>
              <li class="mt-2">
                <span class="badge bg-danger text-white">MERAH</span> : jika
                <strong>Capaian Bulan ini lebih kecil</strong> atau sama dengan
                bulan lalu dan kumulatif di bawah target
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      const endpoint =
        "https://script.google.com/macros/s/AKfycbyXUb1qcb9YTr8nv4C1Ad2p2ifqosTbRBF0B-rg8bb1f2Tc9hy4LMwrIaZia1YIkPMD6w/exec";

      let originalData = [];
      let selectedBulan = "Juli";
      let selectedkategori = "Semua";

      const bulanKeys = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "Mei",
        "Juni",
        "Juli",
        "Agst",
        "Sept",
        "Okt",
        "Nov",
        "Des",
      ];

      const labelMap = {
        Jan: "Januari",
        Feb: "Februari",
        Mar: "Maret",
        Apr: "April",
        Mei: "Mei",
        Juni: "Juni",
        Juli: "Juli",
        Agst: "Agustus",
        Sept: "September",
        Okt: "Oktober",
        Nov: "November",
        Des: "Desember",
      };

      const masalahMap = {
        Januari: "Masalah_Jan",
        Februari: "Masalah_Feb",
        Maret: "Masalah_Mar",
        April: "Masalah_Apr",
        Mei: "Masalah_Mei",
        Juni: "Masalah_Jun",
        Juli: "Masalah_Jul",
        Agustus: "Masalah_Agu",
        September: "Masalah_Sep",
        Oktober: "Masalah_Okt",
        November: "Masalah_Nov",
        Desember: "Masalah_Des",
      };
      const analisaMap = {
        Januari: "Analisa_masalah_jan",
        Februari: "Analisa_Masalah_Feb",
        Maret: "Analisa_Masalah_Mar",
        April: "Analisa_Masalah_Apr",
        Mei: "Analisa_Masalah_Mei",
        Juni: "Analisa_Masalah_Jun",
        Juli: "Analisa_Masalah_Jul",
        Agustus: "Analisa_Masalah_Agu",
        September: "Analisa_Masalah_Sep",
        Oktober: "Analisa_Masalah_Okt",
        November: "Analisa_Masalah_Nov",
        Desember: "Analisa_Masalah_Des",
      };
      const rtlMap = {
        Januari: "RTL_Jan",
        Februari: "RTL_Feb",
        Maret: "RTL_Mar",
        April: "RTL_Apr",
        Mei: "RTL_Mei",
        Juni: "RTL_Jun",
        Juli: "RTL_Jul",
        Agustus: "RTL_Agu",
        September: "RTL_Sep",
        Oktober: "RTL_Okt",
        November: "RTL_Nov",
        Desember: "RTL_Des",
      };
      const hasilMap = {
        Januari: "Hasil_Jan",
        Februari: "Hasil_Feb",
        Maret: "Hasil_Mar",
        April: "Hasil_Apr",
        Mei: "Hasil_Mei",
        Juni: "Hasil_Jun",
        Juli: "Hasil_Jul",
        Agustus: "Hasil_Agus",
        September: "Hasil_Sep",
        Oktober: "Hasil_Okt",
        November: "Hasil_Nop",
        Desember: "Hasil_Des",
      };

      window.onload = function () {
        const kategoriFromURL = getQueryParam("kategori");
        if (kategoriFromURL) {
          selectedkategori = decodeURIComponent(kategoriFromURL);
          // Set dropdown ke kategori yang sesuai
          document.getElementById("kategoriSelect").value = selectedkategori;
        }
        fetch(endpoint)
          .then((res) => res.json())
          .then((data) => {
            originalData = data;
            fetch(endpoint)
              .then((res) => res.json())
              .then((data) => {
                originalData = data;

                console.log("Contoh data:", data[0]); // ‚¨ÖÔ∏è Tambahkan ini untuk lihat struktur field

                // Buat dropdown kategori
                const kategoriSet = new Set(
                  data.map((item) => item.kategori || "Tanpa kategori")
                );

                const kategoriSelect =
                  document.getElementById("kategoriSelect");
                kategoriSet.forEach((kategori) => {
                  const opt = document.createElement("option");
                  opt.value = kategori;
                  opt.textContent = kategori;
                  kategoriSelect.appendChild(opt);
                });

                renderTable(data, selectedBulan);
              });
          })
          .catch((err) => {
            document.getElementById("tableBody").innerHTML =
              "<tr><td colspan='25' class='text-center text-danger'>Gagal memuat data</td></tr>";
            console.error("Fetch error:", err);
          });
      };

      function renderTable(data, bulan) {
        const tbody = document.getElementById("tableBody");

        if (!data || data.length === 0) {
          tbody.innerHTML =
            "<tr><td colspan='25' class='text-center'>Tidak ada data tersedia.</td></tr>";
          return;
        }

        const idx = bulanKeys.indexOf(bulan);
        const bulanIniKey = bulanKeys[idx];
        const bulanLaluKey = bulanKeys[idx - 1] || null;
        const labelBulan = labelMap[bulanIniKey];
        const kolomMasalah = masalahMap[labelBulan] || "Masalah_Jan";
        const kolomAnalisa = analisaMap[labelBulan] || "Analisa_masalah_jan";
        const kolomRTL = rtlMap[labelBulan] || "RTL_jan";

        document.querySelectorAll("thead tr:nth-child(2) th")[0].innerText =
          bulanLaluKey ? labelMap[bulanLaluKey] : "-";
        document.querySelectorAll("thead tr:nth-child(2) th")[1].innerText =
          labelMap[bulanIniKey];

        document.getElementById(
          "targetHeader"
        ).innerText = `% Target s/d Bulan ${labelBulan}`;
        document.getElementById("cakupanBulan").innerText = labelBulan;

        // üîπ Filter berdasarkan kategori
        const filtered =
          selectedkategori === "Semua"
            ? data
            : data.filter(
                (d) => (d.kategori || "Tanpa kategori") === selectedkategori
              );

        // üîπ Grouping berdasarkan Sub
        let grouped = {};
        filtered.forEach((row) => {
          const sub = row.Sub || "Tanpa Sub";
          if (!grouped[sub]) grouped[sub] = [];
          grouped[sub].push(row);
        });

        let rows = "";
        let counter = 1;

        for (let sub in grouped) {
          const rowsInSub = grouped[sub];
          const program = rowsInSub[0].Induk || "";

          rows += `
            <tr><td colspan="13" class="fw-bold text-danger" style="background-color: #f8d7da;">${program}</td></tr>
            <tr><td colspan="13" class="fw-semibold text-primary" style="background-color: #e2e3f3;">${sub}</td></tr>
          `;

          rowsInSub.forEach((row) => {
            const indikator = row["Indikator Kerja"] || "-";
            const bulanIniVal = parseFloat(row[bulanIniKey]);
            const bulanLaluVal = bulanLaluKey
              ? parseFloat(row[bulanLaluKey])
              : 0;
            const targetTahun = parseFloat(row["Target 2025"]) || 0;
            const targetSasaran = parseFloat(row["Target Sasaran"]) || 0;

            const bulanKe = idx + 1;

            const targetSD = targetSasaran
              ? Math.round(((targetSasaran / 12) * bulanKe / targetSasaran) * 100)
              : "-";

            let totalCapaian = 0;
            for (let i = 0; i <= idx; i++) {
              const val = parseFloat(row[bulanKeys[i]]);
              if (!isNaN(val)) totalCapaian += val;
            }

            const cakupanSD = targetSasaran
              ? ((totalCapaian / targetSasaran) * 100).toFixed(2)
              : "-";

            const masalahBulanIni = row[kolomMasalah] || "";
            const analisaBulanIni = row[kolomAnalisa] || "";
            const RTLBulanIni = row[kolomRTL] || "";

            let gap = "-";
            let tren =
              "<i class='bi bi-arrow-right-circle-fill fs-4 text-dark'></i>";
            let trenClass = "";

            // Ganti GAP dari selisih antar bulan => selisih cakupan dan target kumulatif
            const cakupanVal = parseFloat(cakupanSD);
            const targetVal = parseFloat(targetSD);

            if (!isNaN(cakupanVal) && !isNaN(targetVal)) {
              const selisihGap = Math.round(cakupanVal - targetVal);
              gap = `${selisihGap > 0 ? "+" : ""}${selisihGap}`;
            }

            // Tetap hitung tren seperti sebelumnya
            if (!isNaN(bulanIniVal) && !isNaN(bulanLaluVal)) {
              const selisihBulan = (bulanIniVal - bulanLaluVal).toFixed(2);
              if (selisihBulan > 0) {
                tren =
                  "<i class='bi bi-arrow-up-circle-fill fs-4 text-dark'></i>";
                trenClass = "bg-success text-white";
              } else if (selisihBulan < 0) {
                tren =
                  "<i class='bi bi-arrow-down-circle-fill fs-4 text-dark'></i>";
                trenClass = "bg-danger text-white";
              }
            }

            let grade = "-";
            let gradeClass = "";

            if (
              !isNaN(bulanIniVal) &&
              !isNaN(bulanLaluVal) &&
              !isNaN(cakupanSD) &&
              !isNaN(targetSD)
            ) {
              const capaianNaik = bulanIniVal > bulanLaluVal;
              const capaianTurun = bulanIniVal < bulanLaluVal;
              const capaianSama = bulanIniVal === bulanLaluVal;

              const selisihCakupan =
                parseFloat(cakupanSD) - parseFloat(targetSD);

              if ((capaianNaik || capaianSama) && selisihCakupan >= 0) {
                grade = "";
                gradeClass = "bg-primary text-white";
              } else if (capaianTurun && selisihCakupan >= 0) {
                grade = "";
                gradeClass = "bg-success text-white";
              } else if (capaianNaik && selisihCakupan < 0) {
                grade = "";
                gradeClass = "bg-warning text-dark";
              } else if ((capaianTurun || capaianSama) && selisihCakupan < 0) {
                grade = "";
                gradeClass = "bg-danger text-white";
              }
            }

            rows += `
              <tr>
                <td class="text-center">${counter++}</td>
                <td class="text-wrap "  title="${indikator}">${indikator}</td>
                <td class="text-wrap text-center">${
                  isNaN(bulanLaluVal) ? "-" : bulanLaluVal
                }</td>
                <td class="text-wrap text-center">${
                  isNaN(bulanIniVal) ? "-" : bulanIniVal
                }</td>
                <td class="text-wrap text-center">${targetSD}</td>
                <td class="text-wrap text-center">${cakupanSD}</td>
                <td class="text-center">${gap}</td>
                <td class="text-center">${tren}</td>
                <td class="${gradeClass} text-center fw-semibold">${grade}</td>
                <td>
                  <textarea class="form-control form-control-sm masalah-textarea"
                    rows="2"
                    data-id="${row["No"]}"
                    data-bulan="${kolomMasalah}">${masalahBulanIni}</textarea>
                </td>
                <td>
                  <textarea class="form-control form-control-sm analisa-textarea"
                    rows="2"
                    data-id="${row["No"]}"
                    data-bulan="${kolomAnalisa}">${analisaBulanIni}</textarea>
                </td>
                <td>
                  <textarea class="form-control form-control-sm rtl-textarea"
                    rows="2"
                    data-id="${row["No"]}"
                    data-bulan="${kolomRTL}">${RTLBulanIni}</textarea>
                </td>
                <td>
                  <textarea class="form-control form-control-sm hasil-textarea"
                    rows="2"
                    data-id="${row["No"]}"
                    data-bulan="Hasil_${bulanIniKey}">${
              row["Hasil_" + bulanIniKey] || ""
            }</textarea>
                </td>

              </tr>`;
          });
        }

        tbody.innerHTML = rows;

        document.querySelectorAll(".masalah-textarea").forEach((textarea) => {
          textarea.addEventListener("change", async function () {
            const id = this.dataset.id;
            const bulan = this.dataset.bulan;
            const nilai = this.value;

            if (id && bulan) {
              try {
                const res = await fetch(
                  `${endpoint}?action=update&id=${encodeURIComponent(
                    id
                  )}&bulan=${encodeURIComponent(
                    bulan
                  )}&nilai=${encodeURIComponent(nilai)}`
                );
                const result = await res.json();
                if (!result.success) {
                  alert("Gagal memperbarui data: " + result.message);
                }
              } catch (err) {
                console.error("Update error:", err);
                alert("Terjadi kesalahan saat menyimpan data.");
              }
            }
          });
        });
        document.querySelectorAll(".analisa-textarea").forEach((textarea) => {
          textarea.addEventListener("change", async function () {
            const id = this.dataset.id;
            const bulan = this.dataset.bulan;
            const nilai = this.value;

            if (id && bulan) {
              try {
                const res = await fetch(
                  `${endpoint}?action=update&id=${encodeURIComponent(
                    id
                  )}&bulan=${encodeURIComponent(
                    bulan
                  )}&nilai=${encodeURIComponent(nilai)}`
                );
                const result = await res.json();
                if (!result.success) {
                  alert("Gagal memperbarui data: " + result.message);
                }
              } catch (err) {
                console.error("Update error (analisa):", err);
                alert("Terjadi kesalahan saat menyimpan data Analisa Masalah.");
              }
            }
          });
        });
        document.querySelectorAll(".rtl-textarea").forEach((textarea) => {
          textarea.addEventListener("change", async function () {
            const id = this.dataset.id;
            const bulan = this.dataset.bulan;
            const nilai = this.value;

            if (id && bulan) {
              try {
                const res = await fetch(
                  `${endpoint}?action=update&id=${encodeURIComponent(
                    id
                  )}&bulan=${encodeURIComponent(
                    bulan
                  )}&nilai=${encodeURIComponent(nilai)}`
                );
                const result = await res.json();
                if (!result.success) {
                  alert("Gagal memperbarui data RTL: " + result.message);
                }
              } catch (err) {
                console.error("Update error (RTL):", err);
                alert("Terjadi kesalahan saat menyimpan data RTL.");
              }
            }
          });
        });
        document.querySelectorAll(".hasil-textarea").forEach((textarea) => {
          textarea.addEventListener("change", async function () {
            const id = this.dataset.id;
            const bulan = this.dataset.bulan;
            const nilai = this.value;

            if (id && bulan) {
              try {
                const res = await fetch(
                  `${endpoint}?action=update&id=${encodeURIComponent(
                    id
                  )}&bulan=${encodeURIComponent(
                    bulan
                  )}&nilai=${encodeURIComponent(nilai)}`
                );
                const result = await res.json();
                if (!result.success) {
                  alert("Gagal memperbarui data Hasil: " + result.message);
                }
              } catch (err) {
                console.error("Update error (Hasil):", err);
                alert("Terjadi kesalahan saat menyimpan data Hasil.");
              }
            }
          });
        });
      }

      // üî∏ Ganti bulan
      document
        .getElementById("bulanSelect")
        .addEventListener("change", function () {
          const bulan = this.value;
          if (bulanKeys.includes(bulan)) {
            selectedBulan = bulan;
            renderTable(originalData, selectedBulan);
          }
        });

      // üî∏ Ganti kategori
      document
        .getElementById("kategoriSelect")
        .addEventListener("change", function () {
          selectedkategori = this.value;
          renderTable(originalData, selectedBulan);
        });
    </script>

    <script>
      document
        .getElementById("simpanMasalah")
        .addEventListener("click", function () {
          const textareas = document.querySelectorAll(".masalah-textarea");
          const analisaAreas = document.querySelectorAll(".analisa-textarea");
          const rtlAreas = document.querySelectorAll(".rtl-textarea"); // Tambahan untuk RTL
          const hasilAreas = document.querySelectorAll(".hasil-textarea");

          const updates = [];

          const bulanDipilih = document.getElementById("bulanSelect").value;
          const labelBulan = labelMap[bulanDipilih];
          const kolomMasalahDipilih = masalahMap[labelBulan];
          const kolomAnalisaDipilih = analisaMap[labelBulan];
          const kolomRTLDipilih = rtlMap[labelBulan]; // Map RTL

          // Masalah
          textareas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            if (kolomBulan !== kolomMasalahDipilih) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          // Analisa
          analisaAreas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            if (kolomBulan !== kolomAnalisaDipilih) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          // RTL
          rtlAreas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            if (kolomBulan !== kolomRTLDipilih) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          // Hasil
          hasilAreas.forEach((textarea) => {
            const id = textarea.getAttribute("data-id");
            const kolomBulan = textarea.getAttribute("data-bulan");

            // Pastikan kolom bulan sesuai Hasil_[BulanIni]
            if (!kolomBulan.includes(`Hasil_${bulanDipilih}`)) return;

            const nilai = textarea.value.trim();
            if (id && kolomBulan && nilai !== "") {
              updates.push({ id, bulan: kolomBulan, nilai });
            }
          });

          if (updates.length === 0) {
            Swal.fire(
              "Tidak ada perubahan",
              "Silakan isi data terlebih dahulu",
              "info"
            );
            return;
          }

          // Kirim update satu per satu
          Promise.all(
            updates.map((item) =>
              fetch(
                `${endpoint}?action=update&id=${encodeURIComponent(
                  item.id
                )}&bulan=${encodeURIComponent(
                  item.bulan
                )}&nilai=${encodeURIComponent(item.nilai)}`
              ).then((res) => res.json())
            )
          )
            .then((results) => {
              const gagal = results.filter((r) => !r.success);
              if (gagal.length > 0) {
                Swal.fire(
                  "Sebagian Gagal",
                  `${gagal.length} data gagal disimpan.`,
                  "warning"
                );
              } else {
                Swal.fire(
                  "Tersimpan!",
                  "Seluruh perubahan berhasil disimpan.",
                  "success"
                );
              }
            })
            .catch((err) => {
              console.error("Kesalahan penyimpanan:", err);
              Swal.fire(
                "Error",
                "Terjadi kesalahan saat menyimpan data.",
                "error"
              );
            });
        });
    </script>
    <script>
      document.getElementById("cetakPDF").addEventListener("click", () => {
        const element = document.querySelector(".table-responsive"); // Bisa diganti ke div/card lain kalau mau
        const opt = {
          margin: 0.5,
          filename: `Laporan_PKP_${selectedBulan}.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "a4", orientation: "landscape" },
        };
      });

      Promise.all(promises).then((results) => {
        const gagal = results.filter((r) => !r.success);
        Swal.close();

        if (gagal.length > 0) {
          Swal.fire(
            "data Berhasil disimpan",
            // `${gagal.length} baris tidak tersimpan.`,
            "success"
          );
        } else {
          Swal.fire({
            icon: "success",
            title: "Data bulan ini berhasil disimpan!",
            timer: 1500,
            showConfirmButton: false,
          });
        }
      });
    </script>
    <script>
      document
        .getElementById("btnPrint")
        .addEventListener("click", function () {
          const printContent = document.createElement("div");

          const tableClone = document
            .querySelector(".table-responsive")
            .cloneNode(true);
          const ttdClone = document
            .getElementById("ttd-section")
            .cloneNode(true);

          printContent.appendChild(tableClone);
          printContent.appendChild(ttdClone);

          const opt = {
            margin: 0.5,
            filename: `Analisa_PKP_${
              new Date().toISOString().split("T")[0]
            }.pdf`,
            image: { type: "jpeg", quality: 0.98 },
            html2canvas: {
              scale: 2,
              useCORS: true,
              allowTaint: true,
            },
            jsPDF: {
              unit: "in",
              format: "a4",
              orientation: "landscape",
            },
          };

          html2pdf().set(opt).from(printContent).save();
        });
    </script>
    <script>
      function getParameterByName(name) {
        const url = new URL(window.location.href);
        return url.searchParams.get(name) || "";
      }

      const namaPelaksana = getParameterByName("nama");

      if (namaPelaksana) {
        document.getElementById("namaPelaksana").textContent = namaPelaksana;
      }
      function getParameterByNIP(nip) {
        const url = new URL(window.location.href);
        return url.searchParams.get(nip) || "";
      }

      const nipPelaksana = getParameterByNIP("nip");

      if (nipPelaksana) {
        document.getElementById("nipPelaksana").textContent =
          "NIP. " + nipPelaksana;
      }
    </script>
    <script>
      function pilihPJDanCetak() {
        const select = document.getElementById("selectPenanggungJawab");
        const selectedValue = select.value;

        if (!selectedValue) {
          alert("Silakan pilih Penanggung Jawab terlebih dahulu.");
          return;
        }

        const [nama, nip] = selectedValue.split("|");

        // Update tampilan di halaman
        document.getElementById("namaPenanggungJawab").textContent = nama;
        document.getElementById("nipPenanggungJawab").textContent =
          "NIP. " + nip;

        // Tutup modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("modalPenanggungJawab")
        );
        modal.hide();

        // Delay sedikit agar modal sempat hilang dulu
        setTimeout(() => {
          window.print();
        }, 300);
      }
    </script>
    <!-- tom select -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        new TomSelect("#selectPenanggungJawab", {
          create: false,
          sortField: {
            field: "text",
            direction: "asc",
          },
          placeholder: "Ketik untuk mencari nama...",
        });
      });
    </script>
  </body>
</html>
